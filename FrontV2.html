<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Pedidos</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        header h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .auth-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .auth-section input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        
        .auth-section button {
            padding: 8px 16px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .auth-section button:hover {
            background-color: #219653;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background-color: #f8f9fa;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.3s;
        }
        
        .tab:hover {
            background-color: #e9ecef;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
            background-color: white;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        table tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-buttons button {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .search-box button {
            padding: 10px 20px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .cep-search {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .cep-search input {
            width: 150px;
        }
        
        .item-pedido {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            text-align: center;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Sistema de Gerenciamento de Pedidos</h1>
            <div class="auth-section">
                <input type="email" id="email" placeholder="E-mail">
                <input type="password" id="password" placeholder="Senha">
                <button id="btn-login">Entrar</button>
                <button id="btn-register">Registrar</button>
            </div>
            <div id="user-info" class="user-info hidden"></div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="pedidos">Pedidos</div>
            <div class="tab" data-tab="clientes">Clientes</div>
            <div class="tab" data-tab="produtos">Produtos</div>
        </div>

        <!-- Tab Pedidos -->
        <div id="pedidos" class="tab-content active">
            <h2>Gerenciar Pedidos</h2>
            
            <div class="search-box">
                <input type="text" id="search-pedidos" placeholder="Buscar pedidos por ID...">
                <button id="btn-buscar-pedidos" class="btn-primary">Buscar</button>
            </div>
            
            <button id="btn-novo-pedido" class="btn-primary">Novo Pedido</button>
            
            <div id="form-pedido" class="hidden">
                <h3 id="titulo-pedido">Novo Pedido</h3>
                <form id="pedido-form">
                    <input type="hidden" id="pedido-id">
                    
                    <div class="form-group">
                        <label for="pedido-cliente">Cliente</label>
                        <select id="pedido-cliente" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pedido-cep">CEP</label>
                        <div class="cep-search">
                            <input type="text" id="pedido-cep" placeholder="Digite o CEP" maxlength="9">
                            <button type="button" id="btn-buscar-cep" class="btn-primary">Buscar CEP</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pedido-endereco">Endere√ßo</label>
                        <input type="text" id="pedido-endereco" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pedido-bairro">Bairro</label>
                            <input type="text" id="pedido-bairro">
                        </div>
                        <div class="form-group">
                            <label for="pedido-cidade">Cidade</label>
                            <input type="text" id="pedido-cidade">
                        </div>
                        <div class="form-group">
                            <label for="pedido-estado">Estado</label>
                            <input type="text" id="pedido-estado">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pedido-status">Status</label>
                        <select id="pedido-status" required>
                            <option value="PENDENTE">PENDENTE</option>
                            <option value="PROCESSANDO">PROCESSANDO</option>
                            <option value="ENVIADO">ENVIADO</option>
                            <option value="ENTREGUE">ENTREGUE</option>
                        </select>
                    </div>
                    
                    <h4>Itens do Pedido</h4>
                    <div id="itens-pedido">
                        <!-- Itens ser√£o adicionados dinamicamente aqui -->
                    </div>
                    
                    <button type="button" id="btn-adicionar-item" class="btn-primary">Adicionar Item</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <button type="submit" class="btn-success">Salvar Pedido</button>
                        <button type="button" id="btn-cancelar-pedido" class="btn-danger">Cancelar</button>
                    </div>
                </form>
            </div>
            
            <table id="tabela-pedidos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Endere√ßo</th>
                        <th>Data</th>
                        <th>Status</th>
                        <th>Total</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="pedidos-body">
                    <!-- Dados ser√£o preenchidos via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Tab Clientes -->
        <div id="clientes" class="tab-content">
            <h2>Gerenciar Clientes</h2>
            
            <div class="search-box">
                <input type="text" id="search-clientes" placeholder="Buscar clientes por nome...">
                <button id="btn-buscar-clientes" class="btn-primary">Buscar</button>
            </div>
            
            <button id="btn-novo-cliente" class="btn-primary">Novo Cliente</button>
            
            <div id="form-cliente" class="hidden">
                <h3 id="titulo-cliente">Novo Cliente</h3>
                <form id="cliente-form">
                    <input type="hidden" id="cliente-id">
                    
                    <div class="form-group">
                        <label for="cliente-nome">Nome</label>
                        <input type="text" id="cliente-nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="cliente-email">E-mail</label>
                        <input type="email" id="cliente-email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="cliente-telefone">Telefone</label>
                        <input type="text" id="cliente-telefone" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-success">Salvar Cliente</button>
                        <button type="button" id="btn-cancelar-cliente" class="btn-danger">Cancelar</button>
                    </div>
                </form>
            </div>
            
            <table id="tabela-clientes">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Telefone</th>
                        <th>Data Cadastro</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="clientes-body">
                    <!-- Dados ser√£o preenchidos via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Tab Produtos -->
        <div id="produtos" class="tab-content">
            <h2>Gerenciar Produtos</h2>
            
            <div class="search-box">
                <input type="text" id="search-produtos" placeholder="Buscar produtos por nome...">
                <button id="btn-buscar-produtos" class="btn-primary">Buscar</button>
            </div>
            
            <button id="btn-novo-produto" class="btn-primary hidden">Novo Produto</button>
            
            <div id="form-produto" class="hidden">
                <h3 id="titulo-produto">Novo Produto</h3>
                <form id="produto-form">
                    <input type="hidden" id="produto-id">
                    
                    <div class="form-group">
                        <label for="produto-nome">Nome</label>
                        <input type="text" id="produto-nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="produto-preco">Pre√ßo</label>
                        <input type="number" id="produto-preco" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="produto-descricao">Descri√ß√£o</label>
                        <textarea id="produto-descricao" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-success">Salvar Produto</button>
                        <button type="button" id="btn-cancelar-produto" class="btn-danger">Cancelar</button>
                    </div>
                </form>
            </div>
            
            <table id="tabela-produtos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Pre√ßo</th>
                        <th>Descri√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="produtos-body">
                    <!-- Dados ser√£o preenchidos via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let token = null;
        let currentUser = null;
        let clientes = [];
        let produtos = [];
        let pedidos = [];
        let itemCounter = 0;

        // Elementos DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const authSection = document.querySelector('.auth-section');
        const userInfo = document.getElementById('user-info');

        // Elementos de autentica√ß√£o
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const btnLogin = document.getElementById('btn-login');
        const btnRegister = document.getElementById('btn-register');

        // Elementos da aba Pedidos
        const formPedido = document.getElementById('form-pedido');
        const pedidoForm = document.getElementById('pedido-form');
        const btnNovoPedido = document.getElementById('btn-novo-pedido');
        const btnCancelarPedido = document.getElementById('btn-cancelar-pedido');
        const pedidosBody = document.getElementById('pedidos-body');
        const pedidoCliente = document.getElementById('pedido-cliente');
        const itensPedido = document.getElementById('itens-pedido');
        const btnAdicionarItem = document.getElementById('btn-adicionar-item');
        const btnBuscarCep = document.getElementById('btn-buscar-cep');
        const pedidoCep = document.getElementById('pedido-cep');
        const pedidoEndereco = document.getElementById('pedido-endereco');
        const pedidoBairro = document.getElementById('pedido-bairro');
        const pedidoCidade = document.getElementById('pedido-cidade');
        const pedidoEstado = document.getElementById('pedido-estado');

        // Elementos da aba Clientes
        const formCliente = document.getElementById('form-cliente');
        const clienteForm = document.getElementById('cliente-form');
        const btnNovoCliente = document.getElementById('btn-novo-cliente');
        const btnCancelarCliente = document.getElementById('btn-cancelar-cliente');
        const clientesBody = document.getElementById('clientes-body');

        // Elementos da aba Produtos
        const formProduto = document.getElementById('form-produto');
        const produtoForm = document.getElementById('produto-form');
        const btnNovoProduto = document.getElementById('btn-novo-produto');
        const btnCancelarProduto = document.getElementById('btn-cancelar-produto');
        const produtosBody = document.getElementById('produtos-body');

        // URLs da API
        const API_BASE = 'http://localhost:8080';
        const AUTH_LOGIN = `${API_BASE}/auth/logar`;
        const AUTH_REGISTER = `${API_BASE}/auth/registrar`;
        const CLIENTES_ENDPOINT = `${API_BASE}/cliente`;
        const PRODUTOS_ENDPOINT = `${API_BASE}/produto`;
        const PEDIDOS_ENDPOINT = `${API_BASE}/pedido`;
        const VIA_CEP_API = 'https://viacep.com.br/ws';

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Abas
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    openTab(tabId);
                });
            });

            // Autentica√ß√£o
            btnLogin.addEventListener('click', fazerLogin);
            btnRegister.addEventListener('click', fazerRegistro);

            // Pedidos
            btnNovoPedido.addEventListener('click', () => mostrarFormPedido());
            btnCancelarPedido.addEventListener('click', () => esconderFormPedido());
            pedidoForm.addEventListener('submit', salvarPedido);
            btnAdicionarItem.addEventListener('click', adicionarItemPedido);
            btnBuscarCep.addEventListener('click', buscarCep);

            // Clientes
            btnNovoCliente.addEventListener('click', () => mostrarFormCliente());
            btnCancelarCliente.addEventListener('click', () => esconderFormCliente());
            clienteForm.addEventListener('submit', salvarCliente);

            // Produtos
            btnNovoProduto.addEventListener('click', () => mostrarFormProduto());
            btnCancelarProduto.addEventListener('click', () => esconderFormProduto());
            produtoForm.addEventListener('submit', salvarProduto);

            // Buscas
            document.getElementById('btn-buscar-pedidos').addEventListener('click', buscarPedidos);
            document.getElementById('btn-buscar-clientes').addEventListener('click', buscarClientes);
            document.getElementById('btn-buscar-produtos').addEventListener('click', buscarProdutos);

            // Verificar se j√° existe um token salvo
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                token = savedToken;
                currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                atualizarInterfaceUsuario();
            }
        });

        // Fun√ß√£o para fazer requisi√ß√µes autenticadas
        async function fazerRequisicaoAutenticada(url, options = {}) {
            if (!token) {
                throw new Error('Token de autentica√ß√£o n√£o encontrado');
            }

            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            };

            const response = await fetch(url, config);
            
            if (response.status === 401) {
                // Token expirado ou inv√°lido
                fazerLogout();
                throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
            }
            
            return response;
        }

        // Fun√ß√µes de Abas
        function openTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Carregar dados da aba selecionada
            if (tabId === 'pedidos') {
                carregarPedidos();
                carregarClientesParaSelect();
                carregarProdutosParaSelect();
            } else if (tabId === 'clientes') {
                carregarClientes();
            } else if (tabId === 'produtos') {
                carregarProdutos();
            }
        }

        // Fun√ß√µes de Autentica√ß√£o
        async function fazerLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                alert('Por favor, preencha e-mail e senha.');
                return;
            }

            try {
                const response = await fetch(AUTH_LOGIN, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    
                    // Decodificar o token JWT para obter informa√ß√µes do usu√°rio
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        currentUser = {
                            email: payload.sub,
                            role: payload.role || 'USER'
                        };
                    } catch (e) {
                        console.error('Erro ao decodificar token:', e);
                        currentUser = { email, role: 'USER' };
                    }
                    
                    // Salvar token e informa√ß√µes do usu√°rio no localStorage
                    localStorage.setItem('token', token);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    atualizarInterfaceUsuario();
                    alert('Login realizado com sucesso!');
                } else {
                    const errorText = await response.text();
                    alert(`Erro no login: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao fazer login:', error);
                alert('Erro ao conectar com o servidor.');
            }
        }

        async function fazerRegistro() {
            const email = emailInput.value;
            const password = passwordInput.value;
            const name = prompt('Digite seu nome:');

            if (!email || !password || !name) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            try {
                const response = await fetch(AUTH_REGISTER, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        name,
                        role: 'USER' // Por padr√£o, registra como USER
                    })
                });

                if (response.ok) {
                    alert('Usu√°rio registrado com sucesso! Fa√ßa login para continuar.');
                    emailInput.value = '';
                    passwordInput.value = '';
                } else {
                    const errorText = await response.text();
                    alert(`Erro no registro: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao registrar:', error);
                alert('Erro ao conectar com o servidor.');
            }
        }

        function fazerLogout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            localStorage.removeItem('currentUser');
            atualizarInterfaceUsuario();
            alert('Logout realizado com sucesso!');
        }

        function atualizarInterfaceUsuario() {
            if (token && currentUser) {
                authSection.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.innerHTML = `
                    Logado como: ${currentUser.email} (${currentUser.role})
                    <button onclick="fazerLogout()" class="btn-danger" style="margin-left: 10px; padding: 5px 10px;">Sair</button>
                `;
                
                // Verificar permiss√µes para mostrar/ocultar funcionalidades
                verificarPermissoesUsuario();
            } else {
                authSection.classList.remove('hidden');
                userInfo.classList.add('hidden');
                
                // Ocultar funcionalidades que requerem autentica√ß√£o
                document.getElementById('btn-novo-produto').classList.add('hidden');
                document.querySelectorAll('#produtos-body tr').forEach(tr => {
                    const acoesTd = tr.querySelector('td:last-child');
                    if (acoesTd) {
                        acoesTd.innerHTML = '<span>Acesso restrito</span>';
                    }
                });
            }
        }

        function verificarPermissoesUsuario() {
            // Verificar se o usu√°rio tem permiss√£o para gerenciar produtos
            const rolesPermitidas = ['ADMIN', 'INFRA', 'SUPERVISOR'];
            const podeGerenciarProdutos = currentUser && rolesPermitidas.includes(currentUser.role);
            
            if (podeGerenciarProdutos) {
                btnNovoProduto.classList.remove('hidden');
            } else {
                btnNovoProduto.classList.add('hidden');
            }
        }

        // Fun√ß√µes para Pedidos
        function mostrarFormPedido(pedido = null) {
            if (!token) {
                alert('Voc√™ precisa estar logado para criar ou editar pedidos.');
                return;
            }

            document.getElementById('titulo-pedido').textContent = pedido ? 'Editar Pedido' : 'Novo Pedido';
            document.getElementById('pedido-id').value = pedido ? pedido.id : '';
            document.getElementById('pedido-cliente').value = pedido && pedido.cliente ? pedido.cliente.id : '';
            document.getElementById('pedido-endereco').value = pedido ? pedido.endereco : '';
            document.getElementById('pedido-status').value = pedido ? pedido.status : 'PENDENTE';
            
            // Limpar itens anteriores
            itensPedido.innerHTML = '';
            itemCounter = 0;
            
            // Adicionar itens existentes se estiver editando
            if (pedido && pedido.itens) {
                pedido.itens.forEach(item => {
                    adicionarItemPedido(item.produto.id, item.quantidade, item.precoUnitario);
                });
            }
            
            formPedido.classList.remove('hidden');
        }

        function esconderFormPedido() {
            formPedido.classList.add('hidden');
            pedidoForm.reset();
            itensPedido.innerHTML = '';
        }

        function adicionarItemPedido(produtoId = '', quantidade = 1, precoUnitario = null) {
            itemCounter++;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-pedido';
            itemDiv.innerHTML = `
                <div class="item-header">
                    <h4>Item ${itemCounter}</h4>
                    <button type="button" class="btn-danger remover-item">Remover</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Produto</label>
                        <select class="item-produto" required>
                            <option value="">Selecione um produto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantidade</label>
                        <input type="number" class="item-quantidade" value="${quantidade}" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Pre√ßo Unit√°rio</label>
                        <input type="number" class="item-preco" value="${precoUnitario || ''}" step="0.01" readonly>
                    </div>
                </div>
            `;
            
            itensPedido.appendChild(itemDiv);
            
            // Preencher select de produtos
            const produtoSelect = itemDiv.querySelector('.item-produto');
            carregarProdutosParaSelect(produtoSelect, produtoId);
            
            // Event listener para remover item
            itemDiv.querySelector('.remover-item').addEventListener('click', function() {
                itemDiv.remove();
            });
            
            // Event listener para atualizar pre√ßo quando produto for selecionado
            produtoSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const preco = selectedOption.getAttribute('data-preco');
                itemDiv.querySelector('.item-preco').value = preco || '';
            });
            
            // Se um produtoId foi fornecido, selecion√°-lo
            if (produtoId) {
                setTimeout(() => {
                    produtoSelect.value = produtoId;
                    const event = new Event('change');
                    produtoSelect.dispatchEvent(event);
                }, 100);
            }
        }

        async function salvarPedido(e) {
            e.preventDefault();
            
            if (!token) {
                alert('Voc√™ precisa estar logado para salvar um pedido.');
                return;
            }
            
            const pedidoId = document.getElementById('pedido-id').value;
            const clienteId = document.getElementById('pedido-cliente').value;
            const endereco = document.getElementById('pedido-endereco').value;
            const status = document.getElementById('pedido-status').value;
            
            // Coletar itens do pedido
            const itens = [];
            const itensElements = document.querySelectorAll('.item-pedido');
            
            itensElements.forEach(itemElement => {
                const produtoId = itemElement.querySelector('.item-produto').value;
                const quantidade = itemElement.querySelector('.item-quantidade').value;
                const precoUnitario = itemElement.querySelector('.item-preco').value;
                
                if (produtoId && quantidade) {
                    itens.push({
                        produtoId: parseInt(produtoId),
                        quantidade: parseInt(quantidade),
                        precoUnitario: parseFloat(precoUnitario)
                    });
                }
            });
            
            if (itens.length === 0) {
                alert('Adicione pelo menos um item ao pedido.');
                return;
            }
            
            const pedidoData = {
                endereco,
                status,
                clienteId: clienteId ? parseInt(clienteId) : null,
                itens
            };
            
            try {
                let response;
                if (pedidoId) {
                    // Atualizar pedido existente
                    response = await fazerRequisicaoAutenticada(`${PEDIDOS_ENDPOINT}/${pedidoId}`, {
                        method: 'PUT',
                        body: JSON.stringify(pedidoData)
                    });
                } else {
                    // Criar novo pedido
                    response = await fazerRequisicaoAutenticada(`${PEDIDOS_ENDPOINT}/save`, {
                        method: 'POST',
                        body: JSON.stringify(pedidoData)
                    });
                }
                
                if (response.ok) {
                    alert(`Pedido ${pedidoId ? 'atualizado' : 'criado'} com sucesso!`);
                    esconderFormPedido();
                    carregarPedidos();
                } else {
                    const errorText = await response.text();
                    alert(`Erro ao ${pedidoId ? 'atualizar' : 'criar'} pedido: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                alert(error.message || 'Erro ao conectar com o servidor.');
            }
        }

        async function carregarPedidos() {
            if (!token) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${PEDIDOS_ENDPOINT}/busca-todos`);
                
                if (response.ok) {
                    pedidos = await response.json();
                    exibirPedidos();
                }
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                alert(error.message);
            }
        }

        function exibirPedidos() {
            pedidosBody.innerHTML = '';
            
            if (pedidos.length === 0) {
                pedidosBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum pedido encontrado.</td></tr>';
                return;
            }
            
            pedidos.forEach(pedido => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${pedido.id}</td>
                    <td>${pedido.cliente ? pedido.cliente.nome : 'N/A'}</td>
                    <td>${pedido.endereco}</td>
                    <td>${new Date(pedido.dataPedido).toLocaleString()}</td>
                    <td>${pedido.status}</td>
                    <td>R$ ${pedido.total ? pedido.total.toFixed(2) : '0.00'}</td>
                    <td class="action-buttons">
                        <button class="btn-primary" onclick="editarPedido(${pedido.id})">Editar</button>
                        <button class="btn-danger" onclick="excluirPedido(${pedido.id})">Excluir</button>
                    </td>
                `;
                pedidosBody.appendChild(tr);
            });
        }

        async function editarPedido(id) {
            try {
                const response = await fazerRequisicaoAutenticada(`${PEDIDOS_ENDPOINT}/${id}`);
                
                if (response.ok) {
                    const pedido = await response.json();
                    mostrarFormPedido(pedido);
                }
            } catch (error) {
                console.error('Erro ao carregar pedido:', error);
                alert(error.message);
            }
        }

        async function excluirPedido(id) {
            if (!confirm('Tem certeza que deseja excluir este pedido?')) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${PEDIDOS_ENDPOINT}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Pedido exclu√≠do com sucesso!');
                    carregarPedidos();
                } else {
                    const errorText = await response.text();
                    alert(`Erro ao excluir pedido: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao excluir pedido:', error);
                alert(error.message || 'Erro ao conectar com o servidor.');
            }
        }

        function buscarPedidos() {
            const termo = document.getElementById('search-pedidos').value.trim();
            
            if (!termo) {
                exibirPedidos();
                return;
            }
            
            const pedidosFiltrados = pedidos.filter(pedido => 
                pedido.id.toString().includes(termo)
            );
            
            pedidosBody.innerHTML = '';
            
            if (pedidosFiltrados.length === 0) {
                pedidosBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum pedido encontrado.</td></tr>';
                return;
            }
            
            pedidosFiltrados.forEach(pedido => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${pedido.id}</td>
                    <td>${pedido.cliente ? pedido.cliente.nome : 'N/A'}</td>
                    <td>${pedido.endereco}</td>
                    <td>${new Date(pedido.dataPedido).toLocaleString()}</td>
                    <td>${pedido.status}</td>
                    <td>R$ ${pedido.total ? pedido.total.toFixed(2) : '0.00'}</td>
                    <td class="action-buttons">
                        <button class="btn-primary" onclick="editarPedido(${pedido.id})">Editar</button>
                        <button class="btn-danger" onclick="excluirPedido(${pedido.id})">Excluir</button>
                    </td>
                `;
                pedidosBody.appendChild(tr);
            });
        }

        // Fun√ß√µes para Clientes
        function mostrarFormCliente(cliente = null) {
            if (!token) {
                alert('Voc√™ precisa estar logado para criar ou editar clientes.');
                return;
            }

            document.getElementById('titulo-cliente').textContent = cliente ? 'Editar Cliente' : 'Novo Cliente';
            document.getElementById('cliente-id').value = cliente ? cliente.id : '';
            document.getElementById('cliente-nome').value = cliente ? cliente.nome : '';
            document.getElementById('cliente-email').value = cliente ? cliente.email : '';
            document.getElementById('cliente-telefone').value = cliente ? cliente.telefone : '';
            formCliente.classList.remove('hidden');
        }

        function esconderFormCliente() {
            formCliente.classList.add('hidden');
            clienteForm.reset();
        }

        async function salvarCliente(e) {
            e.preventDefault();
            
            if (!token) {
                alert('Voc√™ precisa estar logado para salvar um cliente.');
                return;
            }
            
            const clienteId = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value;
            const email = document.getElementById('cliente-email').value;
            const telefone = document.getElementById('cliente-telefone').value;
            
            const clienteData = {
                nome,
                email,
                telefone
            };
            
            try {
                let response;
                if (clienteId) {
                    // Atualizar cliente existente
                    response = await fazerRequisicaoAutenticada(`${CLIENTES_ENDPOINT}/${clienteId}`, {
                        method: 'PUT',
                        body: JSON.stringify(clienteData)
                    });
                } else {
                    // Criar novo cliente
                    response = await fazerRequisicaoAutenticada(`${CLIENTES_ENDPOINT}/save`, {
                        method: 'POST',
                        body: JSON.stringify(clienteData)
                    });
                }
                
                if (response.ok) {
                    alert(`Cliente ${clienteId ? 'atualizado' : 'criado'} com sucesso!`);
                    esconderFormCliente();
                    carregarClientes();
                    carregarClientesParaSelect(); // Atualizar select de clientes na aba de pedidos
                } else {
                    const errorText = await response.text();
                    alert(`Erro ao ${clienteId ? 'atualizar' : 'criar'} cliente: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                alert(error.message || 'Erro ao conectar com o servidor.');
            }
        }

        async function carregarClientes() {
            if (!token) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${CLIENTES_ENDPOINT}/busca-todos`);
                
                if (response.ok) {
                    clientes = await response.json();
                    exibirClientes();
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                alert(error.message);
            }
        }

        function exibirClientes() {
            clientesBody.innerHTML = '';
            
            if (clientes.length === 0) {
                clientesBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum cliente encontrado.</td></tr>';
                return;
            }
            
            clientes.forEach(cliente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente.id}</td>
                    <td>${cliente.nome}</td>
                    <td>${cliente.email}</td>
                    <td>${cliente.telefone}</td>
                    <td>${new Date(cliente.dataCadastro).toLocaleString()}</td>
                    <td class="action-buttons">
                        <button class="btn-primary" onclick="editarCliente(${cliente.id})">Editar</button>
                        <button class="btn-danger" onclick="excluirCliente(${cliente.id})">Excluir</button>
                    </td>
                `;
                clientesBody.appendChild(tr);
            });
        }

        async function editarCliente(id) {
            try {
                const response = await fazerRequisicaoAutenticada(`${CLIENTES_ENDPOINT}/${id}`);
                
                if (response.ok) {
                    const cliente = await response.json();
                    mostrarFormCliente(cliente);
                }
            } catch (error) {
                console.error('Erro ao carregar cliente:', error);
                alert(error.message);
            }
        }

        async function excluirCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${CLIENTES_ENDPOINT}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Cliente exclu√≠do com sucesso!');
                    carregarClientes();
                    carregarClientesParaSelect(); // Atualizar select de clientes na aba de pedidos
                } else {
                    const errorText = await response.text();
                    alert(`Erro ao excluir cliente: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                alert(error.message || 'Erro ao conectar com o servidor.');
            }
        }

        function buscarClientes() {
            const termo = document.getElementById('search-clientes').value.trim();
            
            if (!termo) {
                exibirClientes();
                return;
            }
            
            // Fazer busca na API
            fazerRequisicaoAutenticada(`${CLIENTES_ENDPOINT}/busca-por-nome/${termo}`)
            .then(response => response.ok ? response.json() : [])
            .then(clientesFiltrados => {
                clientesBody.innerHTML = '';
                
                if (clientesFiltrados.length === 0) {
                    clientesBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum cliente encontrado.</td></tr>';
                    return;
                }
                
                clientesFiltrados.forEach(cliente => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cliente.id}</td>
                        <td>${cliente.nome}</td>
                        <td>${cliente.email}</td>
                        <td>${cliente.telefone}</td>
                        <td>${new Date(cliente.dataCadastro).toLocaleString()}</td>
                        <td class="action-buttons">
                            <button class="btn-primary" onclick="editarCliente(${cliente.id})">Editar</button>
                            <button class="btn-danger" onclick="excluirCliente(${cliente.id})">Excluir</button>
                        </td>
                    `;
                    clientesBody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar clientes:', error);
                alert(error.message);
            });
        }

        async function carregarClientesParaSelect() {
            if (!token) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${CLIENTES_ENDPOINT}/busca-todos`);
                
                if (response.ok) {
                    const clientes = await response.json();
                    pedidoCliente.innerHTML = '<option value="">Selecione um cliente</option>';
                    
                    clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = cliente.nome;
                        pedidoCliente.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar clientes para select:', error);
            }
        }

        // Fun√ß√µes para Produtos
        function mostrarFormProduto(produto = null) {
            if (!token) {
                alert('Voc√™ precisa estar logado para criar ou editar produtos.');
                return;
            }

            document.getElementById('titulo-produto').textContent = produto ? 'Editar Produto' : 'Novo Produto';
            document.getElementById('produto-id').value = produto ? produto.id : '';
            document.getElementById('produto-nome').value = produto ? produto.nome : '';
            document.getElementById('produto-preco').value = produto ? produto.preco : '';
            document.getElementById('produto-descricao').value = produto ? produto.descricao : '';
            formProduto.classList.remove('hidden');
        }

        function esconderFormProduto() {
            formProduto.classList.add('hidden');
            produtoForm.reset();
        }

        async function salvarProduto(e) {
            e.preventDefault();
            
            if (!token) {
                alert('Voc√™ precisa estar logado para salvar um produto.');
                return;
            }
            
            const produtoId = document.getElementById('produto-id').value;
            const nome = document.getElementById('produto-nome').value;
            const preco = document.getElementById('produto-preco').value;
            const descricao = document.getElementById('produto-descricao').value;
            
            const produtoData = {
                nome,
                preco: parseFloat(preco),
                descricao
            };
            
            try {
                let response;
                if (produtoId) {
                    // Atualizar produto existente
                    response = await fazerRequisicaoAutenticada(`${PRODUTOS_ENDPOINT}/${produtoId}`, {
                        method: 'PUT',
                        body: JSON.stringify(produtoData)
                    });
                } else {
                    // Criar novo produto
                    response = await fazerRequisicaoAutenticada(`${PRODUTOS_ENDPOINT}/save`, {
                        method: 'POST',
                        body: JSON.stringify(produtoData)
                    });
                }
                
                if (response.ok) {
                    alert(`Produto ${produtoId ? 'atualizado' : 'criado'} com sucesso!`);
                    esconderFormProduto();
                    carregarProdutos();
                    carregarProdutosParaSelect(); // Atualizar select de produtos na aba de pedidos
                } else {
                    const errorText = await response.text();
                    alert(`Erro ao ${produtoId ? 'atualizar' : 'criar'} produto: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                alert(error.message || 'Erro ao conectar com o servidor.');
            }
        }

        async function carregarProdutos() {
            if (!token) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${PRODUTOS_ENDPOINT}/busca-todos`);
                
                if (response.ok) {
                    produtos = await response.json();
                    exibirProdutos();
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                alert(error.message);
            }
        }

        function exibirProdutos() {
            produtosBody.innerHTML = '';
            
            if (produtos.length === 0) {
                produtosBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum produto encontrado.</td></tr>';
                return;
            }
            
            produtos.forEach(produto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${produto.id}</td>
                    <td>${produto.nome}</td>
                    <td>R$ ${produto.preco.toFixed(2)}</td>
                    <td>${produto.descricao || '-'}</td>
                    <td class="action-buttons">
                        <button class="btn-primary" onclick="editarProduto(${produto.id})">Editar</button>
                        <button class="btn-danger" onclick="excluirProduto(${produto.id})">Excluir</button>
                    </td>
                `;
                produtosBody.appendChild(tr);
            });
        }

        async function editarProduto(id) {
            try {
                const response = await fazerRequisicaoAutenticada(`${PRODUTOS_ENDPOINT}/${id}`);
                
                if (response.ok) {
                    const produto = await response.json();
                    mostrarFormProduto(produto);
                }
            } catch (error) {
                console.error('Erro ao carregar produto:', error);
                alert(error.message);
            }
        }

        async function excluirProduto(id) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${PRODUTOS_ENDPOINT}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Produto exclu√≠do com sucesso!');
                    carregarProdutos();
                    carregarProdutosParaSelect(); // Atualizar select de produtos na aba de pedidos
                } else {
                    const errorText = await response.text();
                    alert(`Erro ao excluir produto: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                alert(error.message || 'Erro ao conectar com o servidor.');
            }
        }

        function buscarProdutos() {
            const termo = document.getElementById('search-produtos').value.trim();
            
            if (!termo) {
                exibirProdutos();
                return;
            }
            
            // Fazer busca na API
            fazerRequisicaoAutenticada(`${PRODUTOS_ENDPOINT}/busca-por-nome/${termo}`)
            .then(response => response.ok ? response.json() : [])
            .then(produtosFiltrados => {
                produtosBody.innerHTML = '';
                
                if (produtosFiltrados.length === 0) {
                    produtosBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum produto encontrado.</td></tr>';
                    return;
                }
                
                produtosFiltrados.forEach(produto => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${produto.id}</td>
                        <td>${produto.nome}</td>
                        <td>R$ ${produto.preco.toFixed(2)}</td>
                        <td>${produto.descricao || '-'}</td>
                        <td class="action-buttons">
                            <button class="btn-primary" onclick="editarProduto(${produto.id})">Editar</button>
                            <button class="btn-danger" onclick="excluirProduto(${produto.id})">Excluir</button>
                        </td>
                    `;
                    produtosBody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar produtos:', error);
                alert(error.message);
            });
        }

        async function carregarProdutosParaSelect(selectElement = null, produtoSelecionadoId = '') {
            if (!token) return;
            
            try {
                const response = await fazerRequisicaoAutenticada(`${PRODUTOS_ENDPOINT}/busca-todos`);
                
                if (response.ok) {
                    const produtos = await response.json();
                    
                    // Se um elemento select foi fornecido, preench√™-lo
                    if (selectElement) {
                        selectElement.innerHTML = '<option value="">Selecione um produto</option>';
                        
                        produtos.forEach(produto => {
                            const option = document.createElement('option');
                            option.value = produto.id;
                            option.textContent = `${produto.nome} - R$ ${produto.preco.toFixed(2)}`;
                            option.setAttribute('data-preco', produto.preco);
                            selectElement.appendChild(option);
                        });
                        
                        // Selecionar o produto se um ID foi fornecido
                        if (produtoSelecionadoId) {
                            selectElement.value = produtoSelecionadoId;
                        }
                    }
                    
                    // Tamb√©m preencher os selects existentes na aba de pedidos
                    const existingSelects = document.querySelectorAll('.item-produto');
                    existingSelects.forEach(select => {
                        if (select.children.length <= 1) { // S√≥ preencher se estiver vazio
                            select.innerHTML = '<option value="">Selecione um produto</option>';
                            
                            produtos.forEach(produto => {
                                const option = document.createElement('option');
                                option.value = produto.id;
                                option.textContent = `${produto.nome} - R$ ${produto.preco.toFixed(2)}`;
                                option.setAttribute('data-preco', produto.preco);
                                select.appendChild(option);
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar produtos para select:', error);
            }
        }

        // Fun√ß√£o para buscar CEP
        async function buscarCep() {
            const cep = pedidoCep.value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                alert('CEP inv√°lido. Digite um CEP com 8 d√≠gitos.');
                return;
            }
            
            try {
                const response = await fetch(`${VIA_CEP_API}/${cep}/json/`);
                const data = await response.json();
                
                if (data.erro) {
                    alert('CEP n√£o encontrado.');
                    return;
                }
                
                pedidoEndereco.value = data.logradouro;
                pedidoBairro.value = data.bairro;
                pedidoCidade.value = data.localidade;
                pedidoEstado.value = data.uf;
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                alert('Erro ao buscar CEP. Tente novamente.');
            }
        }
    </script>
</body>
</html>